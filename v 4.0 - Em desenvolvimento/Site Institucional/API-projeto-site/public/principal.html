<!DOCTYPE html>
<html lang="pt">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Overwatch - Principal</title>
    <link rel="stylesheet" href="./css/principal.css">
    <link rel="shortcut icon" href="Logo.png">
    <link href='https://unpkg.com/boxicons@2.0.9/css/boxicons.min.css' rel='stylesheet'>

    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script type="text/javascript" src="https://www.chartjs.org/dist/2.8.0/Chart.min.js"></script>
    <script type="text/javascript" src="https://www.chartjs.org/samples/latest/utils.js"></script>
    <script type="text/javascript" src="funcoes.js"></script>

</head>

<body onload="atualizacaoPeriodica()" style="overflow-y: scroll">
    <div class="sidebar">
        <div class="logo-content">
            <div class="logo">
                <img src="./img/logo-overwatch.png">
                <div class="nome_logo">Overwacth</div>
            </div>
            <i class='bx bx-menu' id="btn"></i>
        </div>
        <ul class="lista-nav">
            <li href="./principal.html">
                <a href="./principal.html">
                    <i class='bx bxs-dashboard' href="./principal.html"></i>
                    <span class="links" href="./principal.html">Principal</span>
                </a>
                <span class="dica" href="./principal.html">Principal</span>
            </li>
            <li>
                <a href="./cadastro-user.html">
                    <i class='bx bx-chat' href="./cadastro-user"></i>
                    <span class="links" href="./cadastro-user.html">Usuários</span>
                </a>
                <span class="dica" href="./cadastro-user.html">Usuários</span>
            </li>
            <li>
                <a href="./pagina-admnistrador.html">
                    <i class='bx bx-user' href="./pagina-admnistrador.html"></i>
                    <span class="links" href="./pagina-admnistrador.html">Perfil</span>
                </a>
                <span class="dica" href="./pagina-admnistrador.html">Perfil</span>
            </li>
            <li href="./dashboard-ow.html">
                <a href="./dashboard-ow.html">
                    <i class='bx bx-pie-chart-alt-2' href="./dashboard-ow.html"></i>
                    <spam class="links" href="./dashboard-ow.html">Graficos</spam>
                </a>
                <spam class="dica" href="./dashboard-ow.html">Graficos</spam>
            </li>
            <li href="./historico-ow.html">
                <a href="./historico-ow.html">
                    <i class='bx bx-history' href="./historico-ow.html"></i>
                    <spam class="links" href="./historico-ow.html">Historico</spam>
                </a>
                <spam class="dica" href="./historico-ow.html">Historico</spam>
            </li>
        </ul>
        <div class="perfil-content">
            <div class="perfil">
                <div class="icone-perfil">
                    <img src="./img/logo-overwatch.png" alt="">
                    <div class="cargo">
                        <div id="nome_usuario_logado2" class="nome">Bruno Leonardo</div>
                        <div class="trabalho">Desenvolvedor</div>
                    </div>
                </div>
                <li>
                    <a href="#">
                        <i class='bx bx-log-out' id='logout' onclick="logoff()"></i>
                        <span class="links" onclick="logoff()"></span>
                    </a>
                </li>
            </div>
        </div>
    </div>
    <div class="home-content">
        <div class="header">
            <div class="header-content">
                <div class="container-name">
                    <div id="nome_usuario_logado" class="nome-empresa">Bem vindo, Bruno Leonardo</div>
                    <div class="ow">Principal Overwatch</div>
                </div>
            </div>
        </div>
        <div class="alertas-content">
            <div id="servidor" class="box-alerta" value="1">
                <div class="info-alerta">Servidor - 1</div>
                <div id="div_cpu" class="quant-numero" style="color: red;">00.0%</div>
                <div id="div_memoriaRam" class="quant-numero" style="color: orange;">00.0%</div>
                <div id="div_disco" class="quant-numero" style="color: green;">00.0%</div>
            </div>
            <div id="servidor" class="box-alerta" value="2">
                <div class="info-alerta">Servidor - 2</div>
                <div id="div_cpu2" class="quant-numero" style="color: red;">00.0%</div>
                <div id="div_memoriaRam2" class="quant-numero" style="color: orange;">00.0%</div>
                <div id="div_disco2" class="quant-numero" style="color: green;">00.0%</div>
            </div>
            <div id="servidor" class="box-alerta" value="3">
                <div class="info-alerta">Servidor - 3</div>
                <div id="div_cpu3" class="quant-numero" style="color: red;">00.0%</div>
                <div id="div_memoriaRam3" class="quant-numero" style="color: orange;">00.0%</div>
                <div id="div_disco3" class="quant-numero" style="color: green;">00.0%</div>
            </div>

        </div>
</body>

</html>

<script>
    let btn = document.querySelector("#btn");
    let sidebar = document.querySelector(".sidebar");
    let searchBtn = document.querySelector(".bx-search-alt");

    btn.onclick = function () {
        sidebar.classList.toggle("active");
    }
    searchBtn.onclick = function () {
        sidebar.classList.toggle("active");
    }

    let usuario;
    let proximaAtualizacao;

    function atualizacaoPeriodica() {
        obterdadosporservidor(1);
        obterdadosporservidor(2);
        obterdadosporservidor(3);
        setTimeout(atualizacaoPeriodica, 2000);
        nome_usuario();
    }

    function nome_usuario() {
        if (sessionStorage.nome_usuario_meuapp == undefined) {
            window.location.href = 'loginecadastro.html';
        } else {
            var nome_usuario = sessionStorage.nome_usuario_meuapp;
            console.log(nome_usuario)
            nome_usuario_logado.innerHTML = `Bem-Vindo, ${nome_usuario}!`

            var nome_usuario2 = sessionStorage.nome_usuario_meuapp;
            console.log(nome_usuario2)
            nome_usuario_logado2.innerHTML = `${nome_usuario2}!`
        }
    }

    function obterdadosporservidor(fkCodigoServidor) {
        fetch(`/leituras/dashboard-ow/${fkCodigoServidor}`)
            .then(resposta => {

                if (resposta.ok) {
                    resposta.json().then(function (resposta) {

                        console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);

                        var dados = {
                            cpu: resposta.cpu,
                            memoriaRam: resposta.memoriaRam,
                            disco: resposta.disco
                        }

                        atualizarTela(dados, fkCodigoServidor);
                    });
                } else {
                    console.error('Nenhum dado encontrado ou erro na API');
                }
            })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados do servidor p/ gráfico: ${error.message}`);
            });
    }

    function atualizarTela(dados, fkCodigoServidor) {
        console.log('iniciando atualização da tela...');

        var div_cpu_alterar
        var div_memoriaRam_alterar
        var div_disco_alterar

        if (fkCodigoServidor == 1) {
            div_cpu_alterar = div_cpu
            div_memoriaRam_alterar = div_memoriaRam
            div_disco_alterar = div_disco
        } else if (fkCodigoServidor == 2) {
            div_cpu_alterar = div_cpu2
            div_memoriaRam_alterar = div_memoriaRam2
            div_disco_alterar = div_disco2
        } else if (fkCodigoServidor == 3) {
            div_cpu_alterar = div_cpu3
            div_memoriaRam_alterar = div_memoriaRam3
            div_disco_alterar = div_disco3
        }

        div_cpu_alterar.innerHTML = `CPU: <br> ${dados.cpu}%`;

        div_memoriaRam_alterar.innerHTML = `Memória Ram: <br> ${dados.memoriaRam}%`;

        div_disco_alterar.innerHTML = `Disco: <br> ${dados.disco}%`;
    }

    function sendData() {
        var http = new XMLHttpRequest();
        http.open('GET', 'http://localhost:9001/api/sendData', false);
        http.send(null);
    }


    setInterval(() => {
        sendData();
    }, 5000);
</script>